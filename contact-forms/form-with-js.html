<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Contact Form (JS Enhanced)</title>
        <link rel="icon" href="../assets/cv-favicon-16.png" sizes="16x16" type="image/png">
        <link rel="icon" href="../assets/cv-favicon-32.png" sizes="32x32" type="image/png">
        <link rel="stylesheet" href="../main.css">
        <style>
            * { box-sizing: border-box; }

            .contact-form-layout {
                flex: 1;
                width: min(720px, 92vw);
                margin: 1rem auto 2rem;
                padding: 1rem 1.25rem;
                border: 3px solid var(--primary-text);
                border-radius: 0;
                background-color: color-mix(in srgb, var(--foreground) 85%, transparent);
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .contact-form-layout h1 {
                text-align: center;
                margin: 0;
                color: var(--primary-text);
            }

            .contact-form-layout form {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                padding: 1rem 1.25rem;
                border: 1px solid color-mix(in srgb, var(--primary-text) 75%, transparent);
                border-radius: 0;
                background-color: color-mix(in srgb, var(--foreground) 92%, transparent);
            }

            fieldset {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                border: none;
                padding: 0;
                margin: 0;
            }

            legend {
                font-weight: bold;
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
                color: var(--secondary-text);
            }

            label {
                display: block;
                color: var(--button-text);
            }

            .optional-indicator {
                font-size: 0.9rem;
                font-style: italic;
                color: var(--tertiary-text);
            }

            input,
            textarea {
                font-family: inherit;
                width: 100%;
                padding: 0.5rem;
                margin-bottom: 0.5rem;
                border: 1px solid color-mix(in srgb, var(--primary-text) 50%, CanvasText);
                border-radius: 0;
                background-color: Canvas;
                color: CanvasText;
            }

            input:focus,
            textarea:focus {
                outline: 2px solid var(--secondary-text);
                outline-offset: 2px;
            }

            input:user-invalid,
            textarea:user-invalid {
                border-color: #dc2626;
            }

            input:required:valid,
            textarea:required:valid {
                border-color: green;
            }

            input:optional:not(:placeholder-shown):valid,
            textarea:optional:not(:placeholder-shown):valid {
                border-color: green;
            }

            output[id="error-message"],
            output[id="info-message"] {
                display: block;
                min-height: 1.2em;
                margin-top: 0rem;
                font-size: 0.9rem;
            }

            output[id="error-message"] {
                color: #dc2626;
                font-weight: bold;
            }

            output[id="info-message"] {
                color: var(--secondary-text);
            }

            input[type="submit"] {
                align-self: flex-start;
                background-color: var(--primary-text);
                color: CanvasText;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 0;
                cursor: pointer;
                transition: background-color var(--theme-transition-duration) ease,
                            color var(--theme-transition-duration) ease;
            }

            input[type="submit"]:hover {
                background-color: color-mix(in srgb, var(--secondary-text) 70%, var(--primary-text));
            }

            .flash-error {
                animation: flash 0.75s ease-out;
            }

            @keyframes flash {
                from { background-color: #fee2e2; }
                to   { background-color: #ffffff; }
            }

            .fade-out {
                animation: fadeOut 1.5s ease-out forwards;
            }

            @keyframes fadeOut {
                0%   { opacity: 1; }
                70%  { opacity: 1; }
                100% { opacity: 0; }
            }

            #info-message.char-count-normal {
                color: green;
                font-weight: bold;
            }

            #info-message.char-count-warning {
                color: #d97706;
                font-weight: bold;
            }

            #info-message.char-count-error {
                color: #dc2626;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <header>
            <hgroup class="brand">
                <h2>Kevin Cohen</h2>
                <p>&gt; Player One</p>
            </hgroup>

            <nav>
                <ul>
                    <li><a href="/index.html">HOME</a></li>
                    <li><a href="/resume.html">ABOUT</a></li>
                    <li><a href="/projects.html">PROJECTS</a></li>
                    <li><a href="/blog.html">BLOG</a></li>
                </ul>
            </nav>

            <label class="theme-toggle" aria-label="Toggle between light and dark theme">
                <input type="checkbox" name="color-scheme" aria-label="Dark mode toggle">
                <span class="toggle-track">
                    <span class="toggle-thumb"></span>
                </span>
            </label>
        </header>
        <main class="contact-form-layout">
            <h1>Contact Form</h1>

            <form action="https://httpbin.org/post" method="post">
                <fieldset>
                    <legend>Your Details</legend>

                    <label for="name">Name:</label>
                    <input id="name" name="name" type="text" placeholder="John Smith" autocomplete="name" required autofocus
                    minlength="2" maxlength="50" pattern="[A-ZÀ-ÖØ-öø-ÿ][A-Za-zÀ-ÖØ-öø-ÿ '\-]{1,49}"
                    title="Name must start with an uppercase letter and may include letters, spaces, hyphens, and apostrophes (2-50 characters)." aria-describedby="error-message info-message">

                    <label for="email">Email:</label>
                    <input id="email" name="email" type="email" placeholder="jsmith@example.com" autocomplete="email" required
                    minlength="5" maxlength="100" title="Please enter a valid email address." aria-describedby="error-message info-message">
                </fieldset>
                <fieldset>
                    <legend>Message</legend>

                    <label for="subject">Subject: <span class="optional-indicator">(optional)</span></label>
                    <input id="subject" name="subject" placeholder="What's this about?" type="text"
                    minlength="2" maxlength="100" pattern="[A-Za-zÀ-ÖØ-öø-ÿ0-9 .,!?'\-]{2,100}"
                    title="Subject may include letters, numbers, spaces, and basic punctuation." aria-describedby="error-message info-message">

                    <label for="comments">Your Comments:</label>
                    <textarea id="comments" name="comments" rows="5" placeholder="Tell us your thoughts!" required
                    minlength="2" maxlength="1000" aria-describedby="error-message info-message"></textarea>
                </fieldset>

                <input name="possible_bot" value="true" type="hidden">
                <input name="form-errors" id="form-errors" type="hidden">

                <output id="info-message"></output>
                <output id="error-message"></output>

                <input type="submit" value="Send Message">
            </form>
        </main>
        <script src="../assets/theme-toggle.js" defer></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const form = document.querySelector('form');
                const nameInput = document.getElementById('name');
                const emailInput = document.getElementById('email');
                const subjectInput = document.getElementById('subject');
                const commentsInput = document.getElementById('comments');
                const formErrorsInput = document.getElementById('form-errors');
                const submitBtn = document.querySelector('input[type="submit"]');

                const errorOutput = document.getElementById('error-message');
                const infoOutput = document.getElementById('info-message');

                // Track which fields have been touched by the user
                const touched = {};

                const form_errors = [];
                let submitAttempt = 0;

                // Shows the first field's error in form order (only for touched fields)
                function updateErrorDisplay() {
                    const fields = [ // Is this a good place to use FormData? Seems hardcoded
                        { key: 'name', input: nameInput },
                        { key: 'email', input: emailInput },
                        { key: 'subject', input: subjectInput },
                        { key: 'comments', input: commentsInput }
                    ];

                    for (const field of fields) {
                        if (touched[field.key] && field.input.validationMessage) {
                            errorOutput.textContent = field.input.validationMessage;
                            return;
                        }
                    }

                    errorOutput.textContent = '';
                }

                // Show temporary error message with fade-out effect
                function showTemporaryError(message, inputElement) {
                    inputElement.classList.remove('flash-error');
                    void inputElement.offsetWidth; // Force reflow to restart animation? Not sure if good or needed
                    inputElement.classList.add('flash-error');

                    errorOutput.textContent = message;
                    errorOutput.classList.remove('fade-out');
                    void errorOutput.offsetWidth; // Same as before
                    errorOutput.classList.add('fade-out');

                    // After animation completes, restore the validation error display
                    setTimeout(() => {
                        if (errorOutput.textContent === message) {
                            errorOutput.classList.remove('fade-out');
                            updateErrorDisplay();
                        }
                    }, 1500);
                }

                // Mask input based on allowed pattern
                function maskInput(inputElement, allowedPattern, fieldName) {
                    inputElement.addEventListener('beforeinput', (event) => {
                        // Only check character input (not delete, paste, etc.)
                        if (event.inputType === 'insertText' && event.data) {
                            const char = event.data;

                            if (!allowedPattern.test(char)) {
                                event.preventDefault();
                                showTemporaryError(`Invalid character "${char}" - not allowed in ${fieldName}.`, inputElement);
                            }
                        }
                    });
                }

                function updateCharacterCount(textareaElement, maxLength) {
                    const currentLength = textareaElement.value.length;
                    const remaining = maxLength - currentLength;

                    infoOutput.classList.remove('char-count-normal', 'char-count-warning', 'char-count-error');

                    if (currentLength >= maxLength) {
                        // At or over the limit (error)
                        if (currentLength > maxLength) {
                            infoOutput.textContent = `Character limit exceeded by ${currentLength - maxLength}!`;
                        } else {
                            infoOutput.textContent = `0 characters remaining`;
                        }
                        infoOutput.classList.add('char-count-error');
                    } else if (remaining <= 50) {
                        // Near the limit (warning)
                        infoOutput.textContent = `${remaining} characters remaining`;
                        infoOutput.classList.add('char-count-warning');
                    } else if (currentLength > 0) {
                        // Normal count (green)
                        infoOutput.textContent = `${remaining} characters remaining`;
                        infoOutput.classList.add('char-count-normal');
                    } else {
                        infoOutput.textContent = '';
                    }
                }

                // Set up input masking for fields with patterns
                maskInput(nameInput, /[A-Za-zÀ-ÖØ-öø-ÿ '\-]/, 'Name');
                maskInput(subjectInput, /[A-Za-zÀ-ÖØ-öø-ÿ0-9 .,!?'\-]/, 'Subject');

                // Initialize character count display
                updateCharacterCount(commentsInput, commentsInput.maxLength);

                nameInput.addEventListener('input', (event) => {
                    touched.name = true;
                    const v = nameInput.validity;
                    let message = '';

                    if (v.valueMissing) {
                        message = 'Name is required.';
                    } else if (v.tooShort) {
                        message = `Name must be at least ${nameInput.minLength} characters.`;
                    } else if (v.tooLong) {
                        message = `Name must be ${nameInput.maxLength} characters or less.`;
                    } else if (v.patternMismatch) {
                        const value = nameInput.value;
                        if (value && !/^[A-ZÀ-ÖØ-öø-ÿ]/.test(value)) {
                            message = 'Name must start with an uppercase letter.';
                        } else {
                            message = 'Name may only include letters, spaces, hyphens, and apostrophes.';
                        }
                    }

                    if (message) {
                        nameInput.setCustomValidity(message);
                    } else {
                        nameInput.setCustomValidity('');
                    }
                    nameInput.reportValidity();
                    updateErrorDisplay();
                });

                emailInput.addEventListener('input', () => {
                    touched.email = true;
                    const v = emailInput.validity;
                    let message = '';

                    if (v.valueMissing) {
                        message = 'Email is required.';
                    } else if (v.typeMismatch) {
                        message = 'Please enter a valid email address like name@example.com.';
                    } else if (v.tooShort) {
                        message = `Email must be at least ${emailInput.minLength} characters.`;
                    } else if (v.tooLong) {
                        message = `Email must be ${emailInput.maxLength} characters or less.`;
                    }

                    if (message) {
                        emailInput.setCustomValidity(message);
                    } else {
                        emailInput.setCustomValidity('');
                    }

                    emailInput.reportValidity();
                    updateErrorDisplay();
                });

                subjectInput.addEventListener('input', () => {
                    touched.subject = true;
                    const value = subjectInput.value;
                    let message = '';

                    // Subject is optional: only validate if user typed something
                    if (value !== '') {
                        const v = subjectInput.validity;

                        if (v.tooShort) {
                            message = `Subject must be at least ${subjectInput.minLength} characters.`;
                        } else if (v.tooLong) {
                            message = `Subject must be ${subjectInput.maxLength} characters or less.`;
                        } else if (v.patternMismatch) {
                            message = 'Subject may include only letters, numbers, spaces, and basic punctuation.';
                        }
                    }

                    if (message) {
                        subjectInput.setCustomValidity(message);
                    } else {
                        subjectInput.setCustomValidity('');
                    }

                    subjectInput.reportValidity();
                    updateErrorDisplay();
                });

                commentsInput.addEventListener('input', () => {
                    touched.comments = true;
                    const v = commentsInput.validity;
                    const currentLength = commentsInput.value.length;
                    const maxLength = commentsInput.maxLength;
                    let message = '';

                    // Check if over the limit (this shouldn't happen with maxlength, but just in case)
                    if (currentLength > maxLength) {
                        message = `Comments must be ${maxLength} characters or less.`;
                    } else if (v.valueMissing) {
                        message = 'Comments are required.';
                    } else if (v.tooShort) {
                        message = `Comments must be at least ${commentsInput.minLength} characters.`;
                    } else if (v.tooLong) {
                        message = `Comments must be ${maxLength} characters or less.`;
                    }

                    if (message) {
                        commentsInput.setCustomValidity(message);
                    } else {
                        commentsInput.setCustomValidity('');
                    }

                    commentsInput.reportValidity();
                    updateErrorDisplay();

                    // Update character count in info message
                    updateCharacterCount(commentsInput, maxLength);
                });

                submitBtn.addEventListener('click', (event) => {
                    submitAttempt++;

                    const fields = [ // There HAS to be a better way to do this...
                        { key: 'name',     input: nameInput },
                        { key: 'email',    input: emailInput },
                        { key: 'subject',  input: subjectInput },
                        { key: 'comments', input: commentsInput }
                    ];

                    const attemptErrors = [];

                    // Look at each field's validity at the moment of submission
                    for (const field of fields) {
                        if (!field.input.checkValidity()) {
                            attemptErrors.push({
                                field: field.key,
                                type: 'validation',
                                message: field.input.validationMessage,
                                value: field.input.value,
                                submitAttempt,
                                time: new Date().toISOString()
                            });
                        }
                    }

                    if (attemptErrors.length > 0) {
                        // This submit attempt FAILED — prevent submission and record errors
                        event.preventDefault(); // is this the right usage? doesnt it already stop submission of invalid forms?
                        form_errors.push(...attemptErrors);
                        formErrorsInput.value = JSON.stringify(form_errors);
                    } else {
                        // This submit is valid — include only history of previous failed attempts
                        formErrorsInput.value = JSON.stringify(form_errors);
                        // Let the browser submit normally
                    }
                });

            });
        </script>
        <noscript>
            <p class="no-js-warning">Theme preference will not be saved without JavaScript. Some helper interactions on this form also require it.</p>
        </noscript>
    </body>
</html>
